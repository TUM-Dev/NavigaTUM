schema_name: Shortbread
schema_description: A basic, lean, general-purpose vector tile schema for OpenStreetMap data. See https://shortbread.geofabrik.de/
attribution: <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>
examples: shortbread_custom.spec.yml
args:
  simplify_tolerance: 1
  simplify_tolerance_at_max_zoom: 0.05
  min_feature_size_at_max_zoom: 0.05
  min_feature_size: 2
  maxzoom: 15
  render_maxzoom: 15
  area:
    description: Geofabrik area to download
    default: germany
  osm_url:
    description: OSM URL to download
    default: '${ args.area == "planet" ? "aws:latest" : ("geofabrik:" + args.area) }'
sources:
  ocean:
    type: shapefile
    url: https://osmdata.openstreetmap.de/download/water-polygons-split-3857.zip
  osm:
    type: osm
    url: '${ args.osm_url }'
definitions:
  # TODO let attribute definitions set multiple keys so you can just use `- *names`
  attributes:
  - &name
    key: name
    type: string
    value:
      coalesce:
        - tag_value: name:de
        - tag_value: name
        - tag_value: name:en
        - value: ''

layers:

##  Water

- id: ocean
  features:
  - source: ocean
    geometry: polygon

- id: water_polygons
  features:
  - source: osm
    geometry: polygon
    min_zoom:
      default_value: 4
      overrides: &water_zoom_overrides
        10:
          waterway: [ dock, canal ]
    include_when: &water_filter
      natural:
      - glacier
      - water
      waterway:
      - riverbank
      - dock
      - canal
      landuse:
      - reservoir
      - basin
    attributes:
    - key: kind
      type: match_value

- id: water_polygons_labels
  features:
  - source: osm
    geometry: polygon_centroid
    min_zoom:
      default_value: 14
      overrides: *water_zoom_overrides
    include_when: *water_filter
    exclude_when:
      name: ''
    attributes:
    - key: kind
      type: match_value
    - *name

- id: water_lines
  features:
  - source: osm
    geometry: line
    min_zoom:
      default_value: 9
      overrides:
        14:
          waterway: [ stream, ditch ]
    # TODO rivers and canals min length=0.25px
    include_when:
      waterway:
      - canal
      - river
      - stream
      - ditch
    attributes:
    - key: kind
      type: match_value
    - &water_lines_attr_tunnel
      key: tunnel
      value: true
      include_when:
        tunnel: [ yes, building_passage ]
        covered: yes
      else: false
    - &water_lines_attr_bridge
      key: bridge
      value: true
      include_when:
        bridge:
          - yes
          - viaduct
          - boardwalk
          - cantilever
          - covered
          - low_water_crossing
          - movable
          - trestle
      else: false

- id: water_lines_labels
  features:
  - source: osm
    geometry: line
    min_zoom:
      default_value: 12
      overrides:
        14:
          waterway: [ stream, ditch ]
    # TODO rivers and canals min length=0.25px
    include_when:
      waterway:
      - canal
      - river
      - stream
      - ditch
    exclude_when:
      name: ''
    attributes:
    - key: kind
      type: match_value
    - *name
    - *water_lines_attr_tunnel
    - *water_lines_attr_bridge

- id: dam_lines
  features:
  - source: osm
    geometry: line
    min_zoom: 12
    include_when: &dam_filter
      # note that dykes are not dams
      waterway: dam
    attributes: &dam_atrs
    - key: kind
      value: dam

- id: dam_polygons
  features:
  - source: osm
    geometry: polygon
    min_zoom: 12
    include_when: *dam_filter
    attributes: *dam_atrs

- id: pier_lines
  features:
  - source: osm
    geometry: line
    min_zoom: 12
    include_when: &pier_filter
      man_made: 
        - pier
        - breakwater
        - groyne
    attributes: &pier_attrs
    - key: kind
      type: match_value

- id: pier_polygons
  features:
  - source: osm
    geometry: polygon
    min_zoom: 12
    include_when: *pier_filter
    attributes: *pier_attrs

##  Countries, States, Cities
- id: boundaries
  features:
  - source: osm
    geometry: line
    # TODO get min admin level from relations
    min_size: 0
    min_zoom:
      default_value: 5
      overrides:
        0:
          admin_level: 2
    include_when:
      __all__:
      - boundary: administrative
      - admin_level: [ 2, 4 ]
    attributes:
    - key: maritime
      type: boolean
      value: true
      include_when:
        maritime: __any__
        natural: coastline
      else: false
    - key: admin_level
      type: integer
    - key: disputed
      value: true
      include_when:
        disputed: yes
        # TODO: member of a relation with boundary=disputed and (admin_level unset or between 2 and 4)
        # see https://github.com/shortbread-tiles/shortbread-docs/issues/43
      else: false

- id: place_labels
  features:
  - source: osm
    geometry: point
    include_when:
      place:
      - city
      - town
      - village
      - hamlet
      - suburb
      - quarter
      - neighbourhood
      - isolated_dwelling
      - farm
      - island
      - locality
    exclude_when:
      name: ''
    min_zoom:
      default_value: 10
      overrides:
        4:
          __all__:
            place: [ city, town, village, hamlet ]
            capital: [ yes, '4' ]
        6:
          __all__:
            place: city
            __not__:
              capital: [ yes, '4' ]
        7:
          __all__:
            place: town
            __not__:
              capital: [ yes, '4' ]
    # TODO z-order
    attributes:
    - key: kind
      value:
        default_value: '${ match_value }'
        overrides:
          capital:
            __all__:
              place: [ city, town, village, hamlet ]
              capital: yes
          state_capital:
            __all__:
              place: [ city, town, village, hamlet ]
              capital: '4'
    - *name
    - key: population
      type: integer
      value:
        match:
        - value: '${ feature.tags.get("population") }'
          if: { population: __any__ }
        - value: 100000
          if: { place: city }
        - value: 5000
          if: { place: town }
        - value: 1000
          if: { place: suburb }
        - value: 500
          if: { place: quarter }
        - value: 100
          if: { place: [ village, neighborhood ] }
        - value: 50
          if: { place: hamlet }
        - value: 5
          if: { place: [ isolated_dwelling, farm ] }
        - else: 0

##  Land Use, Land Cover, Buildings
- id: land
  features:
  - source: osm
    geometry: polygon
    include_when:
      amenity:
      - grave_yard
      landuse:
      - allotments
      - brownfield
      - cemetery
      - commercial
      - farmland
      - farmyard
      - forest
      - flowerbed
      - garages
      - grass
      - greenfield
      - greenhouse_horticulture
      - industrial
      - landfill
      - meadow
      - orchard
      - plant_nursery
      - quarry
      - railway
      - recreation_ground
      - residential
      - retail
      - village_green
      - vineyard
      leisure:
      - garden
      - golf_course
      - miniature_golf
      - park
      - playground
      natural:
      - bare_rock
      - beach
      - grassland
      - heath
      - sand
      - scree
      - scrub
      - shrubbery
      - shingle
      - wood
      barrier:
      - hedge
      - wall
      wetland:
      - bog
      - marsh
      - string_bog
      - swamp
      - wet_meadow
    min_zoom:
      default_value: 12
      overrides:
        7:
          natural: wood
          landuse: forest
        10:
          landuse:
          - brownfield
          - commercial
          - farmland
          - farmyard
          - garages
          - greenfield
          - industrial
          - landfill
          - railway
          - residential
          - retail
          natural:
          - beach
          - sand
        13:
          amenity: grave_yard
          landuse:
          - grass
          - cemetery
          - flowerbed
          natural:
          - scrub
        15:
          barrier:
          - hedge
          - wall
    attributes:
    - key: kind
      value: '${match_value == "forest" ? "wood": match_value}'
  tile_post_process:
    merge_polygons:
      min_area: 0.5

- id: sites
  features:
  - source: osm
    geometry: polygon
    min_zoom:
      default_value: 14
      overrides:
        10:
          amenity: university
    include_when:
      military: danger_area
      leisure:
      - sports_centre
      - pitch
      landuse: construction
      amenity:
      - university
      - hospital
      - prison
      - parking
      - bicycle_parking
      - motorcycle_parking
      - bicycle_rental
    attributes:
    - key: kind
      type: match_value
    - key: surface
      include_when:
        __all__:
          leisure:
            - pitch
            - sports_centre
          surface:
            - sand
            - grass
            - tartan
  tile_post_process:
    merge_polygons:
      min_area: 1

- id: buildings
  features:
  - source: osm
    geometry: polygon
    min_zoom: 13
    include_when:
      building: __any__
    exclude_when:
      building: no
    attributes:
    - key: height
      type: integer
      value:
        - if: { height: __any__ }
          value: '${ feature.tags["height"].matches(r"^\d+ ?m?$") ? uint(feature.tags["height"].replace(" m", "").replace("m", "")) : 4u }'
        - if: { "building:levels": __any__ }
          value: '${ feature.tags["building:levels"].matches(r"^\d+$") ? uint(feature.tags["building:levels"]) * 3u : 4u }'
        - else: 4
      min_zoom: 14
    - key: min_height
      type: integer
      value:
        - if: { min_height: __any__ }
          value: '${ feature.tags["min_height"].matches(r"^\d+ ?m?$") ? uint(feature.tags["min_height"].replace(" m", "").replace("m", "")) : 4u }'
        - if: { "building:min_level": __any__ }
          value: '${ feature.tags["building:min_level"].matches(r"^\d+$") ? uint(feature.tags["building:min_level"]) * 3u : 4u }'
        - else: 0
      min_zoom: 14
  tile_post_process:
    merge_polygons:
      min_area: 2

- id: addresses
  features:
  - source: osm
    geometry: polygon_centroid_if_convex
    min_zoom: 15
    include_when: &address_filter
      addr:housenumber: __any__
    attributes: &address_attributes
    - key: housenumber
      tag_value: addr:housenumber
  - source: osm
    geometry: point
    min_zoom: 15
    include_when: *address_filter
    attributes: *address_attributes

##  Streets and Transport
- id: streets
  features:
  - source: osm
    geometry: line
    min_size: 0
    min_zoom:
      default_value: 13
      overrides:
        5:
          highway: motorway%
        6:
          highway: trunk%
        8:
          highway: primary%
          __all__:
            railway: [ rail, narrow_gauge ]
            service: __any__
        9:
          highway: secondary%
        10:
          __all__:
            railway: [ rail, narrow_gauge ]
            service: ''
          railway:
          - funicular
          - light_rail
          - monorail
          - subway
          - tram
          highway: tertiary
        11:
          aeroway: runway
        12:
          highway: [ residential, unclassified ]
    #  TODO   min_tile_cover_size: 0
    # TODO z-order
    include_when:
      highway:
      - motorway
      - motorway_link
      - trunk
      - trunk_link
      - primary
      - primary_link
      - secondary
      - secondary_link
      - tertiary
      - tertiary_link
      - unclassified
      - residential
      - living_street
      - service
      - pedestrian
      - track
      - footway
      - steps
      - path
      - cycleway
      aeroway: # TODO update shortbread spec
      - runway
      - taxiway
      railway:
      - rail
      - narrow_gauge
      - tram
      - light_rail
      - funicular
      - subway
      - monorail
    attributes:
    - key: kind
      value: '${ match_value.replace("_link", "") }'
    - key: link
      min_zoom: 11
      value: true
      include_when:
        highway: '%_link'
      else: false
    - key: rail
      min_zoom: 11
      value: true
      include_when:
        railway: __any__
      else: false
    - &tunnel_attr
      key: tunnel
      min_zoom: 11
      value: true
      include_when:
        tunnel: [ yes, building_passage ]
        covered: yes
      else: false
    - &bridge_attr
      key: bridge
      min_zoom: 11
      value: true
      include_when:
        bridge: yes
      else: false
  tile_post_process:
    merge_line_strings:
      min_length: 0.1
      tolerance: 1
      buffer: 1

- id: street_polygons
  features:
  - source: osm
    geometry: polygon
    min_zoom: 14
    include_when:
      __all__:
      - highway: [ pedestrian, service ]
      - area: yes
    attributes:
    - key: kind
      type: match_value
    - *bridge_attr
    - *tunnel_attr
  tile_post_process:
    merge_polygons:
      min_area: 1

- id: street_labels
  features:
  - source: osm
    geometry: line
    min_zoom:
      default_value: 14
      overrides:
        10:
          highway: motorway
        12:
          highway: [ trunk, primary ]
        13:
          highway:
          - motorway_link
          - trunk_link
          - primary_link
          - secondary
          - secondary_link
          - tertiary
    include_when:
      highway:
      - motorway
      - motorway_link
      - trunk
      - trunk_link
      - primary
      - primary_link
      - secondary
      - secondary_link
      - tertiary
      - tertiary_link
      - unclassified
      - residential
      - living_street
      - service
      - pedestrian
      - track
      - footway
      - steps
      - path
      - cycleway
    exclude_when:
      __all__:
        name: ''
        ref: ''
    attributes:
    - key: kind
      value: '${ match_value.replace("_link", "") }'
    - *name
    # TODO use ref var to avoid duplicating logic
    - key: ref
      exclude_when: &missing_ref
        ref: ''
      value: '${ feature.tags["ref"].replace(";", "\n") }'
    - key: ref_cols
      value: '${ max(feature.tags["ref"].split(";").map(r, size(r))) }'
      exclude_when: *missing_ref
    - key: ref_rows
      value: '${ size(feature.tags["ref"].split(";")) }'
      exclude_when: *missing_ref

- id: street_polygons_labels
  features:
  - source: osm
    geometry: polygon_point_on_surface
    min_zoom: 14
    include_when:
      __all__:
        highway: [ pedestrian, service ]
        area: yes
        name: __any__
    attributes:
    - key: kind
      type: match_value
    - *name

- id: street_labels_points
  features:
  - source: osm
    geometry: point
    min_zoom: 12
    include_when:
      highway: motorway_junction
    attributes:
    - key: kind
      type: match_value
    - key: ref
    - *name

- id: bridges
  features:
  - source: osm
    geometry: polygon
    min_zoom: 12
    include_when:
       man_made: bridge
    attributes:
    - key: kind
      value: bridge
  tile_post_process:
    merge_polygons:
      min_area: 1

- id: aerialways
  features:
  - source: osm
    geometry: line
    min_zoom: 12
    include_when:
      aerialway:
      - cable_car
      - gondola
      - goods
      - chair_lift
      - drag_lift
      - t-bar
      - j-bar
      - platter
      - rope_tow
    attributes:
    - key: kind
      type: match_value
  tile_post_process:
    merge_polygons:
      min_area: 1

- id: ferries
  features:
  - source: osm
    geometry: line
    min_zoom:
      default_value: 12
      overrides:
        10:
          __not__:
            motor_vehicle: no
    include_when:
      route: ferry
    attributes:
    - key: kind
      type: match_value
    - *name

##  Points of Interest
- id: public_transport
  features:
  - source: osm
    geometry: point
    min_zoom: &public_transport_zoom
      default_value: 14
      overrides:
        11:
          aeroway: aerodrome
          railway: station
        12:
          amenity: ferry_terminal
        13:
          railway: [ station, halt ]
          aerialway: station
          aeroway: helipad
          amenity: bus_station
    include_when: &public_transport_filter
      aerialway: station
      aeroway: [ aerodrome, helipad ]
      amenity: [ bus_station, ferry_terminal ]
      highway: bus_stop
      railway: [ station, halt, tram_stop ]
    attributes: &public_transport_attrs
    - key: kind
      value:
        # only aerialway=station needs special handling
        coalesce:
        - tag_value: aeroway
        - tag_value: amenity
        - tag_value: railway
        - tag_value: highway
        - "aerialway_station"
    - key: subway
      value:
        - if: { subway: yes }
          value: true
        - else: false
    - *name
  - source: osm
    geometry: polygon_point_on_surface
    min_zoom: *public_transport_zoom
    include_when: *public_transport_filter
    attributes: *public_transport_attrs


- id: pois
  features:
  - source: osm
    geometry: point
    min_zoom: 15
    include_when: &poi_filter
      amenity: &poi_filter_amenity
        - atm
        - bank
        - bar
        - bench
        - bicycle_rental
        - bicycle_parking
        - biergarten
        - cafe
        - car_wash
        - cinema
        - clinic
        - community_centre
        - charging_station
        - drinking_water
        - fast_food
        - fire_station
        - food_court
        - fountain
        - fuel
        - grave_yard
        - hospital
        - ice_cream
        - library
        - lounger
        - motorcycle_parking
        - parking
        - pharmacy
        - place_of_worship
        - police
        - post_box
        - post_office
        - pub
        - recycling
        - restaurant
        - school
        - shelter
        - theatre
        - toilets
        - university
        - vending_machine
        - waste_basket
      emergency: &poi_filter_emergency
        - defibrillator
        - fire_hydrant
        - phone
        - access_point
      leisure: &poi_filter_leisure
        - pitch
        - sports_centre
        - stadium
        - swimming_pool
        - picnic_table
        - water_park
      #man_made: &poi_filter_man_made
      #  - tower
      #  - wastewater_plant
      #  - water_well
      #  - watermill
      shop: &poi_filter_shop
        - alcohol
        - bakery #
        - beverages #
        - butcher #
        - convenience #
        - department_store #
        - greengrocer #
        - kiosk #
        - supermarket #
      #tourism: &poi_filter_tourism
      #  - artwork
      #  - alpine_hut
      #  - bed_and_breakfast
      #  - camp_site
      #  - caravan_site
      #  - chalet
      #  - guest_house
      #  - hostel
      #  - hotel
      #  - motel
      #  - museum
      #  - picnic_site
      #  - theme_park
      #  - viewpoint
      #  - zoo
    attributes: &poi_attrs
     # For the attributes below, we need to include_when, as otherwise
     # the any-filter above could add variants if contains one matching and one non-matching variant
    - key: amenity
      include_when:
        amenity: *poi_filter_amenity
    - key: leisure
      include_when:
        leisure:  *poi_filter_leisure
    #- key: tourism
    #  include_when:
      #    tourism:  *poi_filter_tourism
    - key: shop
      include_when:
        shop:  *poi_filter_shop
    #- key: man_made
    #  include_when:
    #    man_made:  *poi_filter_man_made
    - key: emergency
      include_when:
        emergency:  *poi_filter_emergency
    - *name
    - key: sport
      include_when:
        leisure:
          - pitch
          - sports_centre
    - key: surface
      include_when:
        __all__:
          leisure:
            - pitch
            - sports_centre
          surface:
            - sand
            - grass
            - tartan
    - key: vending
      include_when:
        amenity: vending_machine
    - key: information
      include_when:
        tourism: information
    #- key: tower:type
    #  include_when:
      #    man_made: tower
    - key: atm
      type: boolean
      value:
        - if: { atm: yes }
          value: true
        - else: false
      include_when:
        amenity: bank
    - key: capacity
      type: integer
      include_when:
        amenity:
          - bicycle_parking
          - bicycle_rental
          - motorcycle_parking
          - parking
  - source: osm
    geometry: polygon_point_on_surface
    min_zoom: 14
    include_when: *poi_filter
    attributes: *poi_attrs

- id: platform_polygons
  features:
  - source: osm
    geometry: polygon
    min_zoom: 15
    include_when:
      public_transport: platform
  tile_post_process:
    merge_polygons:
      min_area: 1

- id: trees
  features:
  - source: osm
    geometry: point
    min_zoom: 15
    include_when:
      natural:
        - tree
        - shrub
      barrier: planter

- id: tree_rows
  features:
  - source: osm
    geometry: line
    min_zoom: 15
    include_when:
      natural: tree_row

- id: barrier_lines
  features:
  - source: osm
    geometry: line
    min_size: 0
    min_zoom: 15
    include_when:
      barrier:
      - block # according to wiki not correct, but often used
      - cable_barrier
      - ditch
      - fence
      - guard_rail
      - handrail
      - hedge
      - retaining_wall
      - wall
      - chain
      - jersey_barrier
      - log
      - rope
      - tank_trap
      - tyres
      - delineators
      natural: hedge
    attributes:
    - key: kind
      value:
        match:
          - value: natural
            if: { barrier: [ hedge, log ], natural: hedge }
          - value: soft
            if: { barrier: [block, cable_barrier, chain, ditch, jersey_barrier, rope] }
          - else: wall
  tile_post_process:
    merge_line_strings:
      min_length: 0.1
      tolerance: 0.2
      buffer: 0.2

- id: barrier_points
  features:
  - source: osm
    geometry: point
    min_zoom: 15
    include_when:
      barrier:
      - block
      - bollard
      - cycle_barrier
      - debris
      - full-height_turnstile
      - turnstile
      - gate
      - lift_gate
      - sliding_beam
      - sliding_gate
      - swing_gate
      - wicket_gate
      - bar
      - barrier_board
      - chain
      - jersey_barrier
      - log
      - rope
      - tyres
      - tank_trap
      - bollard
    attributes:
    - key: kind
      value:
        match:
          - value: turnstile
            if: { barrier: [ full-height_turnstile, turnstile ] }
          - value: circle
            if: { barrier: [ bollard ] }
          - value: vehicle_gate
            if: { barrier: [ lift_gate, sliding_beam, sliding_gate, swing_gate ] }
          - value: gate
            if: { barrier: [ gate, cycle_barrier, wicket_gate ] }
          - value: blocking
            if: { barrier: [ bar, barrier_board, chain, jersey_barrier, log, rope, tyres, tank_trap ] }
          - else: unknown
